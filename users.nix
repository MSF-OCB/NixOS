
########################################################################
#                                                                      #
# DO NOT EDIT THIS FILE, ALL EDITS SHOULD BE DONE IN THE GIT REPO,     #
# PUSHED TO GITHUB AND PULLED HERE.                                    #
#                                                                      #
# LOCAL EDITS WILL BE OVERWRITTEN.                                     #
#                                                                      #
########################################################################

{ config, lib, pkgs, ... }:

with lib;

let

  userOpts = { name, config, ... }: {

    options = {

      name = mkOption {
        type = types.str;
      };

      enable = mkOption {
        type = types.bool;
        default = false;
      };

      extraGroups = mkOption {
        type = types.listOf types.str;
        default = [];
      };

      hasShell = mkOption {
        type = types.bool;
        default = false;
      };

      canTunnel = mkOption {
        type = types.bool;
        default = false;
      };

    };

    config = {
      name = mkDefault name;
    };
  };

in {

  options = {

    settings.users = mkOption {
      default = [];
      type = with types; loaOf (submodule userOpts);
    };

  };

  config = let
    toKeyPath = name: ./keys + ("/" + name);
  in {

    users.users = mapAttrs (name: value: {
      name = name;
      isNormalUser = value.hasShell;
      extraGroups = value.extraGroups;
      shell = mkIf (!value.hasShell) pkgs.nologin;
      openssh.authorizedKeys.keyFiles = [ (toKeyPath name) ];
    }) (filterAttrs (name: value: value.enable) config.settings.users);

    settings.reverse_tunnel.relay.tunneller.keyFiles =
      mapAttrsToList (name: value: toKeyPath name)
        (filterAttrs (name: value: value.canTunnel) config.settings.users);

  };

}

