
########################################################################
#                                                                      #
# DO NOT EDIT THIS FILE, ALL EDITS SHOULD BE DONE IN THE GIT REPO,     #
# PUSHED TO GITHUB AND PULLED HERE.                                    #
#                                                                      #
# LOCAL EDITS WILL BE OVERWRITTEN.                                     #
#                                                                      #
########################################################################

{ lib, config, pkgs, ... }:

with lib;

let 
  cfg = config.system.autoUpgrade;
in {

  # https://github.com/NixOS/nixpkgs/pull/77622
  imports = [ ./nixos-upgrade.nix ];

  # We run the upgrade service once at night and once during the day, to catch the situation
  # where the server is turned off every evening.
  # When the service is being run during the day, we will be outside of the reboot window.
  system.autoUpgrade = {
    enable = true;
    allowReboot = true;
    rebootWindow = { lower = "01:00"; upper = "05:00"; };
    dates = "Mon 03,12:20";
  };

  systemd.services = {
    nixos-upgrade.serviceConfig = {
      TimeoutStartSec = "2 days";
    };

    cleanup_auto_roots = {
      description = "Automatically clean up nix auto roots";
      before      = [ "nix-gc.service" ];
      requiredBy  = [ "nix-gc.service" ];
      script = ''
        find /nix/var/nix/gcroots/auto/ -type l -mtime +30 | while read fname; do
          target=$(readlink ''${fname})
          if [ -L ''${target} ]; then
            unlink ''${target}
          fi
        done
      '';
    };
  };

  nix = {
    autoOptimiseStore = true;
    gc = {
      automatic = true;
      dates = "Tue 03:00";
      options = "--delete-older-than 30d";
    };
  };
}

